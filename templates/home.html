{% extends "index.html" %}
{% block title %}Dashboard Overview{% endblock %}

{% block content %}
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<div id="vue-dashboard-app" class="p-4 sm:p-8">

    <header class="mb-8 p-6 bg-white shadow-lg rounded-2xl border border-slate-100 dark:bg-gray-800 dark:border-gray-700">
        <h1 class="text-4xl font-extrabold text-slate-800 dark:text-gray-100">Rasbhari Apps Dashboard</h1>
        <p class="text-slate-500 mt-1 dark:text-gray-400">Overview of key metrics and recent items from all applications.</p>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">

        {% raw %}
        <div v-for="(data, widgetName) in widgetsData" :key="widgetName"
             class="bg-white rounded-2xl overflow-hidden border border-slate-100 transition duration-300
                    hover:shadow-lg hover:border-indigo-200
                    dark:bg-gray-800 dark:border-gray-700 dark:hover:border-indigo-600">

            <header class="p-5 border-b border-slate-100 dark:border-gray-700/50 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800 dark:text-gray-100 capitalize">
                    {{ widgetName }}
                </h2>
                <a :href="`/${widgetName.toLowerCase().replace(' ', '-')}/home`"
                   class="text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 transition duration-150"
                   title="Manage All Items">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </a>
            </header>

            <div class="p-5 space-y-3">
                <div v-if="!data[0] || data[0].length === 0" class="text-center py-4 text-slate-500 italic dark:text-gray-400">
                    No recent items found.
                </div>

                <div v-for="(item, itemIndex) in data[0]" :key="item.id || itemIndex"
                     class="p-3 border border-slate-50 rounded-lg transition duration-150 cursor-pointer
                            hover:bg-indigo-50/50 hover:border-indigo-100
                            dark:border-gray-700/30 dark:hover:bg-gray-700">

                    <dl class="space-y-0.5 text-sm">
                        <template v-for="(value, key, index) in item">
                            <div v-if="shouldShowItem(key, data[1])" :class="['flex justify-between items-start', `wdg-${widgetName.toLowerCase()}-${key}`]">
                                <dt class="font-medium text-slate-500 capitalize pr-2 dark:text-gray-400">
                                    {{ formatKey(key) }}:
                                </dt>
                                <dd class="text-slate-800 truncate max-w-[60%] text-right font-medium dark:text-gray-200">
                                    {{ formatValue(value, key, data[1]) }}
                                </dd>
                            </div>
                        </template>
                    </dl>
                </div>
            </div>
        </div>
        {% endraw %}
    </main>

    <div v-if="Object.keys(widgetsData).length === 0" class="text-center py-20 text-slate-500 dark:text-gray-400">
        <p class="text-2xl font-bold mb-2">No widgets configured.</p>
        <p>Please check your backend configuration.</p>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue

    // Safely embed the dynamic data from Jinja2
    const JINJA_WIDGETS_DATA = JSON.parse('{{ widgets_data | tojson | safe }}');

    const App = {
        setup() {
            const widgetsData = ref(JINJA_WIDGETS_DATA);

            function formatKey(key) {
                if (typeof key !== 'string') return '';
                return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
            }

            function shouldShowItem(key, attributes) {
            console.log(attributes)
                if (typeof key !== 'string') return false;

                // 1. Find the attribute definition
                const attrDef = attributes.find(attr => attr.name === key);

                // 2. Check for existence and the 'widget_enabled' property
                return attrDef && attrDef.widget_enabled;
            }

            function formatValue(value, key, attributes) {
                if (value === null || value === undefined) return 'N/A';

                const attrDef = attributes.find(attr => attr.name === key);
                const type = attrDef ? attrDef.type : null;
                let strValue = String(value);

                if (type && type.includes('datetime')) {
                    try {
                        return new Date(value).toLocaleString('en-US', {
                            year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit'
                        });
                    } catch (e) {
                        return strValue;
                    }
                }

                if (type === 'list' || Array.isArray(value)) {
                    return value.join(', ');
                }

                if (strValue.length > 50) {
                    return strValue.substring(0, 47) + '...';
                }

                return strValue;
            }

            onMounted(() => {
                console.log('Dashboard mounted with widgets:', widgetsData.value);
            });

            return {
                widgetsData,
                formatKey,
                formatValue,
                shouldShowItem
            };
        }
    };

    createApp(App).mount('#vue-dashboard-app');
</script>

{% endblock %}