<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contract Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #0d9488 100%);
      color: #e2e8f0;
    }
    .card {
      background-color: #1e293b;
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }
    input, textarea, select {
      background-color: #0f172a;
      border: 1px solid #334155;
      color: #f8fafc;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #14b8a6;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.4);
    }
    .btn-primary {
      background-color: #14b8a6;
      transition: background-color 0.3s, transform 0.1s;
    }
    .btn-primary:hover { background-color: #0d9488; }
    .btn-primary:active { transform: scale(0.98); }
    .btn-secondary {
      background-color: #334155;
      color: #e2e8f0;
    }
    .contract-card {
      background-color: #111827;
      border-left: 4px solid #14b8a6;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">
  <div class="card w-full max-w-6xl p-10 grid grid-cols-1 md:grid-cols-2 gap-12">
    <!-- Contract Form -->
    <div>
      <h1 id="form-title" class="text-4xl font-extrabold mb-8 text-white tracking-tight">Create New Contract</h1>
      <form id="contract-form" class="space-y-6">
        <input type="hidden" id="contract-id">

        <div>
          <label for="name" class="block text-sm font-semibold text-gray-400">Name</label>
          <input type="text" id="name" required class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-3 focus:outline-none">
        </div>

        <div>
          <label for="description" class="block text-sm font-semibold text-gray-400">Description</label>
          <textarea id="description" rows="3" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-3 focus:outline-none"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="frequency" class="block text-sm font-semibold text-gray-400">Frequency</label>
            <select id="frequency" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-3 focus:outline-none">
              <option value="ad-hoc">Ad-hoc</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div>
            <label for="trigger_event" class="block text-sm font-semibold text-gray-400">Trigger Event</label>
            <input type="text" id="trigger_event" required class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-3 focus:outline-none">
          </div>
        </div>

        <div>
          <label for="conditions" class="block text-sm font-semibold text-gray-400">Conditions</label>
          <textarea id="conditions" rows="3" required class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-3 focus:outline-none"></textarea>
        </div>

        <div>
          <label for="violation_message" class="block text-sm font-semibold text-gray-400">Violation Message</label>
          <textarea id="violation_message" rows="3" required class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-3 focus:outline-none"></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="start_time" class="block text-sm font-semibold text-gray-400">Start Time</label>
            <input type="datetime-local" id="start_time" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-3 focus:outline-none">
          </div>
          <div>
            <label for="end_time" class="block text-sm font-semibold text-gray-400">End Time</label>
            <input type="datetime-local" id="end_time" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-3 focus:outline-none">
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 pt-4">
          <button type="submit" id="submit-btn" class="btn-primary w-full sm:w-auto px-6 py-3 rounded-md shadow-sm text-base font-semibold text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
            Create Contract
          </button>
          <button type="button" id="cancel-btn" class="hidden btn-secondary w-full sm:w-auto px-6 py-3 rounded-md shadow-sm text-base font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
            Cancel
          </button>
        </div>
      </form>
      <div id="status-message" class="mt-6 text-center text-sm font-medium hidden"></div>
    </div>

    <!-- Contract List -->
    <div>
      <h2 class="text-4xl font-extrabold mb-8 text-white tracking-tight">Existing Contracts</h2>
      <div id="contracts-list" class="space-y-6 overflow-y-auto max-h-[75vh] pr-4 no-scrollbar">
        <div class="text-center text-gray-500 p-6">Loading contracts...</div>
      </div>
    </div>
  </div>
    <script>
        const API_URL = '/contracts';
        const form = document.getElementById('contract-form');
        const listContainer = document.getElementById('contracts-list');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        // Function to fetch and render all contracts
        async function fetchContracts() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error('Failed to fetch contracts.');
                }
                const contracts = await response.json();
                renderContracts(contracts);
            } catch (error) {
                console.error("Error fetching contracts:", error);
                listContainer.innerHTML = '<p class="text-red-500 text-center">Failed to load contracts. Please ensure the Flask app is running.</p>';
            }
        }

        function renderContracts(contracts) {
          listContainer.innerHTML = '';
          if (contracts.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500 text-center">No contracts found. Create one above.</p>';
            return;
          }

          contracts.forEach(contract => {
            const startTime = contract.start_time ? new Date(contract.start_time).toLocaleString() : 'N/A';
            const endTime = contract.end_time ? new Date(contract.end_time).toLocaleString() : 'N/A';

            const contractCard = document.createElement('div');
            contractCard.className = 'contract-card p-5 rounded-lg shadow-md hover:shadow-lg transition flex flex-col gap-3';

            contractCard.innerHTML = `
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-lg font-bold text-white">${contract.name}</h3>
                  <div class="flex flex-wrap gap-2 mt-2">
                    <span class="px-2 py-0.5 text-xs rounded-full bg-teal-700 text-teal-100">${contract.frequency}</span>
                    <span class="px-2 py-0.5 text-xs rounded-full bg-slate-700 text-slate-200">Trigger: ${contract.trigger_event}</span>
                  </div>
                </div>
                <div class="flex space-x-2">
                  <button onclick="editContract(${contract.id})" class="text-teal-400 hover:text-teal-200 transition">
                    Edit
                  </button>
                  <button onclick="deleteContract(${contract.id})" class="text-red-400 hover:text-red-200 transition">
                    Delete
                  </button>
                </div>
              </div>

              <p class="text-sm text-gray-400 line-clamp-2">${contract.description || 'No description'}</p>

              <div class="flex flex-wrap gap-2 text-xs text-gray-400">
                <span class="px-2 py-0.5 bg-slate-800 rounded">Conditions: ${contract.conditions}</span>
                <span class="px-2 py-0.5 bg-slate-800 rounded">Violation: ${contract.violation_message}</span>
              </div>

              <p class="text-xs text-gray-500 mt-2">⏳ ${startTime} → ${endTime}</p>
            `;

            listContainer.appendChild(contractCard);
          });
        }


        // Form submission handler for both create and update
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const contractId = document.getElementById('contract-id').value;
            const method = contractId ? 'PUT' : 'POST';
            const url = contractId ? `${API_URL}/${contractId}` : API_URL;

            const startTimeValue = document.getElementById('start_time').value;
            const endTimeValue = document.getElementById('end_time').value;

            const data = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                frequency: document.getElementById('frequency').value,
                trigger_event: document.getElementById('trigger_event').value,
                conditions: document.getElementById('conditions').value,
                violation_message: document.getElementById('violation_message').value,
                // Convert to ISO 8601 string for the server
                start_time: startTimeValue ? new Date(startTimeValue).toISOString() : null,
                end_time: endTimeValue ? new Date(endTimeValue).toISOString() : null
            };

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save contract.');
                }

                resetForm();
                fetchContracts();
                // Replace alert with a more user-friendly message box
                alert('Contract saved successfully!');

            } catch (error) {
                console.error("Error saving contract:", error);
                // Replace alert with a more user-friendly message box
                alert(`Error saving contract: ${error.message}`);
            }
        });

        // Function to fill form for editing
        async function editContract(id) {
            try {
                const response = await fetch(`${API_URL}/${id}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch contract for editing.');
                }
                const contract = await response.json();

                document.getElementById('contract-id').value = contract.id;
                document.getElementById('name').value = contract.name;
                document.getElementById('description').value = contract.description;
                document.getElementById('frequency').value = contract.frequency;
                document.getElementById('trigger_event').value = contract.trigger_event;
                document.getElementById('conditions').value = contract.conditions;
                document.getElementById('violation_message').value = contract.violation_message;

                // Set the datetime-local input values
                const startTime = contract.start_time ? new Date(contract.start_time) : null;
                const endTime = contract.end_time ? new Date(contract.end_time) : null;
                document.getElementById('start_time').value = startTime ? startTime.toISOString().substring(0, 16) : '';
                document.getElementById('end_time').value = endTime ? endTime.toISOString().substring(0, 16) : '';

                formTitle.textContent = "Edit Contract";
                submitBtn.textContent = "Update Contract";
                cancelBtn.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching contract for edit:", error);
                // Replace alert with a more user-friendly message box
                alert(`Error fetching contract for edit: ${error.message}`);
            }
        }

        // Function to delete a contract
        async function deleteContract(id) {
            // Replace confirm with a more user-friendly modal
            if (confirm("Are you sure you want to delete this contract?")) {
                try {
                    const response = await fetch(`${API_URL}/${id}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete contract.');
                    }
                    // Replace alert with a more user-friendly message box
                    alert("Contract deleted successfully!");
                    fetchContracts();
                } catch (error) {
                    console.error("Error deleting contract:", error);
                    // Replace alert with a more user-friendly message box
                    alert(`Error deleting contract: ${error.message}`);
                }
            }
        }

        // Function to reset the form
        function resetForm() {
            form.reset();
            document.getElementById('contract-id').value = '';
            formTitle.textContent = "Create New Contract";
            submitBtn.textContent = "Create Contract";
            cancelBtn.classList.add('hidden');
        }

        cancelBtn.addEventListener('click', resetForm);

        // Initial fetch of contracts when the page loads
        document.addEventListener('DOMContentLoaded', fetchContracts);
    </script>
</body>
</html>
